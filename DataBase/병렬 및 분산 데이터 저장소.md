
# Chapter 21. 병렬 및 분산 데이터 저장소

---

## 1. 데이터 분할

<br>

- **I/O 병렬화** : 다중 디스크상에 릴레이션을 분할, 병렬 접근을 통해 검색 시간을 줄이는 것
- **수평 분할** : 릴레이션의 각 튜플을 서로 다른 노드에 나누어 저장
- **수직 분할** : 각 튜플의 속성을 나누어 저장
- 병렬 데이터베이스 시스템은 데이터를 노드에 분할하고, 노드 안에서 블록과 디스크 할당은 노드의 운영체제가 담당 

<br>

### 1) 분할 기법
1) **라운드-로빈** : 릴레이션을 순서대로 읽어 튜플을 노드에 하나씩 순차적으로 분할
   - 전체 릴레이션을 차례로 읽어가는 질의에 적합
   - 점 질의나 범위 질의에 부적합
2) **해시 분할** : 릴레이션의 하나 이상에 속성을 분할 속성으로 노드의 갯수만큼 범위를 가지는 해시 함수를 선택하여 분할
   - 분할 속성에 대한 점 질의에 적합
   - 비분할 속성에 대한 점 질의, 범위 질의에 부적합
3) **범위 분할** : 연속적인 속성값의 범위를 기준으로 분할
   - 분할 속성에 대한 점 질의와 범위 질의에 적합
   - 범위 질의에 들어 있는 튜플의 수가 적을 경우 하나의 노드에만 질의가 전송되므로 나머지 노드가 다른 질의에 활용될 수 있기에 응답 시간이 빠르고 처리량이 높음
   - 범위 질의에 들어 있는 튜플의 수가 많을 경우 처리 노드에 I/O 병목 현상이 발생

<br>

> 분할 시 오버헤드를 고려하여 작은 크기의 릴레이션은 분할하지 않는 것이, 중간 크기의 릴레이션은 몇 개의 노드에만 분할하는 것이, 큰 크기의 릴레이션은 전체 노드의 분할하는 것이 유리

<br>

### 2) 치우침 처리

<br>

(1) 종류
- **분포 치우침** : 릴레이션 분할 시 일부 노드에 많은 수의 튜플이 저장 
  * 원인
    1) 속성값 치우침 : 분할 속성에서 다수의 튜플이 특정값을 가지는 경우
    2) 분할 치우침 : 분할에 있어 부하의 불균형이 발생하는 경우
- **실행 치우침** : 질의가 일부 분할에만 자주 접근
(2) 처리 방법
 - 정렬 : 릴레이션을 분할 속성에 따라 정렬 후 1/n만큼 나눠 분할
 - 히스토그램 : 정렬을 수행하는 I/O 부담을 줄이기 위해 속성의 분포를 저장해두고 사용
 - 가상 노드 분할 : 실제 노드보다 많은 가상 노드가 있다 가정하고 튜플 수와 부하를 고려하여 실제 노드로 연결
 - 동적 재분할 : 시간이 지남에 따라 치우침이 발생하면 해당 노드를 두 개의 가상 노드로 분할 후 다른 노드로 이전

<br>

## 2. 복제

> 다수의 노드는 단일 노드보다 오동작 가능성이 높으므로 튜플을 복제하여 대응

<br>

- 사본의 위치 : 데이터 센터 내 같은 랙, 다른 랙 혹은 데이터 센터 간 복제
- 복제된 사본이 저장된 장소는 분할 테이블에 기록
- 분할의 복제본을 한 노드에 모두 담으면 해당 노드에 실행 치우침이 발생하므로 여러 노드에 나눠서 복제
- 튜플 갱신 시 복제된 모든 사본을 갱신하기 위해 마스터 사본에서 우선 갱신 후 나머지 사본에도 갱신 요청을 보내고 모두 갱신됐는지 확인

<br>

## 3. 병렬 인덱스

<br>

- **지역 인덱스** : 특정한 노드에 담긴 튜플에 대한 인덱스
- **전역 인덱스** : 여러 노드에 저장된 데이터에 대한 인덱스
  * **전역 주 인덱스** : 릴레이션의 튜플이 분할 시 사용하는 속성에 대한 전역 인덱스
  * **전역 2차 인덱스** : 인덱스 속성이 튜플 분할 시 사용된 속성과 일치하지 않는 전역 인덱스
<br>

## 4. 분산 파일 시스템

<br>

> 여러 대의 컴퓨터에 파일을 나누어 저장, 클라이언트는 단일 파일 시스템과 같은 뷰를 제공

<br>

- 여러 노드에 걸쳐 데이터를 저장
- 단일 파일 블록도 나누어 저장할 수 있고, 컴퓨터 장애에 대비하여 여러 컴퓨터에 복제
- **하둡 파일 시스템**
  * 구글 파일 시스템 설계 기반
  * 네임노드라는 단일 노드에 파일 시스템 메타데이터를 저장하여 사용(단순하고 실용적)
  * 처리율을 높이기 위해 모든 메타데이터를 메모리에 캐시(메모리 용량이 처리에 중요한 역할)
  * 갱신을 허용하지 않음(사본 간 불일치 방지)

<br>

## 5. 병렬 키-값 저장소

<br>

> 데이터 항목을 연관된 키와 함께 저장하고 키에 따라 데이터 항목을 조회

<br>

(1) 종류
- **넓은 열 기반 저장소** : 개별적인 튜플에 열을 추가하거나 삭제가 가능
- **문서 저장소** : 복잡한 구조(JSON과 같은)를 값으로 저장 가능
(2) 특징
 - 노드의 수를 늘리거나 줄이는 유연성 제공
 - 일반적으로 선언적 질의, 트랜잭션, 키가 아닌 속성에 대한 효과적인 레코드 검색이 불가능
 - 일부 저장소는 많은 열 값을 저장하거나, 각 행의 열을 별도로 저장하거나(**열 기반 저장소**), 열의 집합을 묶어 저장(**열 패밀리**)이 가능
 - 장애에 대응하기 위해 복제를 하고 **마스터 노드**(분할 정보의 마스터 복제본을 가짐)를 활용하는데 단일 마스터 노드의 부하를 줄이기 위해 클라이언트 사이트에 분할 정보를 복제하거나 라우터 사이트에 분할 정보를 복제하여 활용
 - 재난에 대비하기 위해 혹은 지리적으로 가까운 지역에서 데이터를 제공하기 위해 **지리적으로 분산된 저장소** 활용 가능
 - 갱신되지 않는 저장소의 경우 인덱스 구조는 로그 구조화된 합병 트리의 변형인 **단계적 합병**을 사용
 - 일반적으로 단일 데이터 항목에 대한 원자적 갱신을 지원하고, 데이터 항목에 갱신이 직렬화 되도록 보장(여러 데이터 항목에서는 원자성 및 직렬 가능성 보장 못함)
 - 특정 개체와 관련된 모든 튜플의 집합(개체 그룹)을 동일 분할에 저장하거나 오래된 항목을 지워줌으로 성능 최적화가 가능
