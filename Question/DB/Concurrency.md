# Concurrency
---

## 면접 질문 예시

> "데이터베이스에서 발생하는 동시성 문제와 이를 해결하기 위한 기법을 설명해보세요"

---

<details>
  <summary><h2> 평가 요소 및 모범 답안</h2></summary>

  ### 1. 동시성 문제 종류 이해
  - 포함내용(예시의 트랜잭션은 time1 - time2 - time3 순서로 진행)
    * 모순된 읽기(DirtyRead) : 커밋 하기 전에 임시 수정을 먼저 봄
      - 트랜잭션A : 상품 가격 변경 - (공백) - 가격 변경 롤백
      - 트랜잭션B : (공백) - 가격 조회 - (공백)
      - 트랜잭션A가 끝나기 전에 트랜잭션 B가 조회를 해서 변경된 가격(이후 롤백이 됨에도)을 읽어버림
    * 비반복적 읽기(Non-Repeatable Read) : 같은 데이터를 두 번 읽을 때 값이 달라짐
      - 트랜잭션A : 재고 조회 - (공백) - 재고 다시 조회
      - 트랜잭션B : (공백) - 재고 수정 - (공백)
      - 트랜잭션A에서 조회한 결과가 트랜잭션B가 중간에 수정함으로 다르게 나옴
    * 유령 읽기(Phantom Read) : 동일한 조건으로 두 번 데이터 검색할 때 다른 결과가 나옴
      - 트랜잭션A : 상품 종류 조회(가격 < 10000) - (공백) - 상품 종류 다시 조회(가격 < 10000)
      - 트랜잭션B : (공백) - 새 상품 추가(가격 = 5000) - (공백)
      - 트랜잭션A에서 조회한 결과가 트랜잭션B가 중간에 삽입함으로 다르게 나옴
    * 갱신 손실(LostUpdate) : 두 트랜잭션이 같은 값을 수정, 마지막 쓰기가 앞선 쓰기 덮어씀
      - 트랜잭션A : 재고 조회(10) - 재고 수정(9) - 커밋
      - 트랜잭션B : 재고 조회(10) - 재고 수정(8) - 커밋
      - 트랜잭션A에서 수정한 결과가 트랜잭션B의 수정에 의해 덮어씌워 짐

  ### 2. 동시성 해결 기법 이해
  - 포함내용(예시의 트랜잭션은 time1 - time2 - time3 순서로 진행)
    * 모순된 읽기(DirtyRead) : 커밋 하기 전에 임시 수정을 먼저 봄
      - 격리 단계를 READ COMMITTED 이상으로 올림
      - 격리 단계(낮은 수준에서 높은 수준 순서로, 격리 수준이 높을 수록 성능은 낮아짐)
        * Read Uncommitted : 다른 트랜잭션에서 커밋되지 않은 데이터 읽을 수 있음
        * Read Committed : 다른 트랜잭션에서 커밋된 데이터만 읽을 수 있음
        * Repeatable Read : 트랜잭션에서 동일한 데이터를 여러 번 읽어도 항상 같은 데이터 반환
        * Serializable : 트랜잭션들을 순차적으로 실행하는 것과 동일한 효과
    * 비반복적 읽기(Non-Repeatable Read) : 같은 데이터를 두 번 읽을 때 값이 달라짐
      - 격리 단계를 Repeatable Read 이상으로 올림
      - 공유 락으로 읽기 동안 행 잠금(읽기 연산은 가능하지만 쓰기 연산은 불가능)
    * 유령 읽기(Phantom Read) : 동일한 조건으로 두 번 데이터 검색할 때 다른 결과가 나옴
      - 격리 단계를 Serializable로 오림
      - 커밋 직전 조건 재검사하고 달라지면 재시도(애플리케이션)
    * 갱신 손실(LostUpdate) : 두 트랜잭션이 같은 값을 수정, 마지막 쓰기가 앞선 쓰기 덮어씀
      - 비관락 : 트랜잭션A가 수행되는 동안 트랜잭션Bㄴ는 대기
      - 낙관락 : 버전 칼럼을 추가하여 버전이 같다면 반영, 버전이 다르다면(다른 트랜잭션이 수행 중) 트랜잭션을 돌려 놓고 다시 시도
     
  
  ### 3.모범 답안 예시
    
      "데이터베이스의 동시성 문제에는 모순된 읽기, 비반복적 읽기, 유령 읽기, 갱신 손실과 같은 문제가 있습니다
      이를 위한 해결 방안으로는 격리 단계를 높은 수준으로 변경하기, 락 활용하기, 애플리케이션 단계에서 확인하는 방법이 있습니다"

  ### 4. 심화 지식
  - 포함내용
    * 동시성 해결 방안 선택 가이드
      - 조회, 갱신이 많고 실시간 정합성은 덜 중요 : READ COMMITTED + 낙관락(대기 거의 없음, 충돌 드물 때 효율적)
      - 정확한 숫자가 최우선(재고, 잔고) : REPEATABLE READ + 비관 락(충돌 적고, 롤백과 재시도 적음)
      - 회계, 법적 데이터 등 규칙 위반 자체가 치명적 : Serializable(규칙 위반 없음)
      - 초고빈도 업데이트(좋아요) : 외부 캐시 이용 후 주기적 적재(DB 락 병목 제거)

    
